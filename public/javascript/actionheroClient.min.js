!function(t,e,n){e[t]=n.call(e),"undefined"!=typeof module&&module.exports?module.exports=e[t]:"function"==typeof define&&define.amd&&define(function(){return e[t]})}("Primus",this,function t(){"use strict";function e(t,e,n){this.fn=t,this.context=e,this.once=n||!1}function n(){}function o(e,n){if(!(e instanceof t)){var o=new Error("Primus#"+n+"'s context should called with a Primus instance");if("function"!=typeof e.listeners||!e.listeners("error").length)throw o;e.emit("error",o)}}function t(e,o){if(!(this instanceof t))return new t(e,o);if("function"!=typeof this.client){var i="The client library has not been compiled correctly, see https://github.com/primus/primus#client-library for more details";return this.critical(new Error(i))}"object"==typeof e?(o=e,e=o.url||o.uri||r):o=o||{};var a=this;o.queueSize="queueSize"in o?o.queueSize:1/0,o.timeout="timeout"in o?o.timeout:1e4,o.reconnect="reconnect"in o?o.reconnect:{},o.ping="ping"in o?o.ping:25e3,o.pong="pong"in o?o.pong:1e4,o.strategy="strategy"in o?o.strategy:[],o.transport="transport"in o?o.transport:{},a.buffer=[],a.writable=!0,a.readable=!0,a.url=a.parse(e||r),a.readyState=t.CLOSED,a.options=o,a.timers={},a.attempt=null,a.socket=null,a.latency=0,a.stamps=0,a.disconnect=!1,a.transport=o.transport,a.transformers={outgoing:[],incoming:[]},"string"==typeof o.strategy&&(o.strategy=o.strategy.split(/\s?\,\s?/g)),!1===o.strategy?o.strategy=[]:o.strategy.length||(o.strategy.push("disconnect","online"),this.authorization||o.strategy.push("timeout")),o.strategy=o.strategy.join(",").toLowerCase(),s||n.call(a),"websockets"in o&&(a.AVOID_WEBSOCKETS=!o.websockets),"network"in o&&(a.NETWORK_EVENTS=o.network),o.manual||(a.timers.open=setTimeout(function(){a.clearTimeout("open").open()},0)),a.initialise(o)}n.prototype._events=void 0,n.prototype.listeners=function(t){if(!this._events||!this._events[t])return[];if(this._events[t].fn)return[this._events[t].fn];for(var e=0,n=this._events[t].length,o=new Array(n);n>e;e++)o[e]=this._events[t][e].fn;return o},n.prototype.emit=function(t,e,n,o,r,i){if(!this._events||!this._events[t])return!1;var s,a,c=this._events[t],u=arguments.length;if("function"==typeof c.fn){switch(c.once&&this.removeListener(t,c.fn,!0),u){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,n),!0;case 4:return c.fn.call(c.context,e,n,o),!0;case 5:return c.fn.call(c.context,e,n,o,r),!0;case 6:return c.fn.call(c.context,e,n,o,r,i),!0}for(a=1,s=new Array(u-1);u>a;a++)s[a-1]=arguments[a];c.fn.apply(c.context,s)}else{var p,f=c.length;for(a=0;f>a;a++)switch(c[a].once&&this.removeListener(t,c[a].fn,!0),u){case 1:c[a].fn.call(c[a].context);break;case 2:c[a].fn.call(c[a].context,e);break;case 3:c[a].fn.call(c[a].context,e,n);break;default:if(!s)for(p=1,s=new Array(u-1);u>p;p++)s[p-1]=arguments[p];c[a].fn.apply(c[a].context,s)}}return!0},n.prototype.on=function(t,n,o){var r=new e(n,o||this);return this._events||(this._events={}),this._events[t]?this._events[t].fn?this._events[t]=[this._events[t],r]:this._events[t].push(r):this._events[t]=r,this},n.prototype.once=function(t,n,o){var r=new e(n,o||this,!0);return this._events||(this._events={}),this._events[t]?this._events[t].fn?this._events[t]=[this._events[t],r]:this._events[t].push(r):this._events[t]=r,this},n.prototype.removeListener=function(t,e,n){if(!this._events||!this._events[t])return this;var o=this._events[t],r=[];if(e&&(o.fn&&(o.fn!==e||n&&!o.once)&&r.push(o),!o.fn))for(var i=0,s=o.length;s>i;i++)(o[i].fn!==e||n&&!o[i].once)&&r.push(o[i]);return r.length?this._events[t]=1===r.length?r[0]:r:delete this._events[t],this},n.prototype.removeAllListeners=function(t){return this._events?(t?delete this._events[t]:this._events={},this):this},n.prototype.off=n.prototype.removeListener,n.prototype.addListener=n.prototype.on,n.prototype.setMaxListeners=function(){return this};var r;try{r=location.origin?location.origin:location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")}catch(i){r="http://127.0.0.1"}t.require=function(t){return"function"!=typeof require?void 0:"function"==typeof define&&define.amd?void 0:require(t)};var s,a;try{t.Stream=s=t.require("stream"),a=t.require("url").parse,t.require("util").inherits(t,s)}catch(i){t.Stream=n,t.prototype=new n,a=function(t){var e,n=document.createElement("a"),o={};n.href=t;for(e in n)("string"==typeof n[e]||"number"==typeof n[e])&&(o[e]=n[e]);if(o.href=encodeURI(decodeURI(o.href)),!o.port){var r=(o.href||"").split("/");if(r.length>2){var i=r[2],s=i.lastIndexOf("@");~s&&(i=i.slice(s+1)),r=i.split(":"),2===r.length&&(o.port=r[1])}}if(o.protocol&&":"!==o.protocol||(o.protocol=o.href.substr(0,o.href.indexOf(":")+1)),"0"===o.port&&(o.port=""),~o.href.indexOf("@")&&!o.auth){var a=o.protocol.length+2;o.auth=o.href.slice(a,o.href.indexOf(o.pathname,a)).split("@")[0]}return o}}t.OPENING=1,t.CLOSED=2,t.OPEN=3,t.prototype.AVOID_WEBSOCKETS=!1,t.prototype.NETWORK_EVENTS=!1,t.prototype.online=!0;try{(t.prototype.NETWORK_EVENTS="onLine"in navigator&&(window.addEventListener||document.body.attachEvent))&&(navigator.onLine||(t.prototype.online=!1))}catch(i){}if(t.prototype.ark={},t.prototype.plugin=function(t){if(o(this,"plugin"),t)return this.ark[t];var e={};for(t in this.ark)e[t]=this.ark[t];return e},t.prototype.reserved=function(t){return/^(incoming|outgoing)::/.test(t)||t in this.reserved.events},t.prototype.reserved.events={readyStateChange:1,reconnecting:1,reconnected:1,reconnect:1,offline:1,timeout:1,online:1,error:1,close:1,open:1,data:1,end:1},t.prototype.initialise=function(e){function n(){i.online&&(i.online=!1,i.emit("offline"),i.end(),i.clearTimeout("reconnect"),i.attempt=null)}function o(){i.online||(i.online=!0,i.emit("online"),~i.options.strategy.indexOf("online")&&i.reconnect())}var r,i=this;i.on("outgoing::open",function(){var e=i.readyState;i.readyState=t.OPENING,e!==i.readyState&&i.emit("readyStateChange","opening"),r=+new Date}),i.on("incoming::open",function(){var e=i.readyState,n=i.attempt;if(i.attempt&&(i.attempt=null),i.writable=!0,i.readable=!0,i.online||(i.online=!0,i.emit("online")),i.readyState=t.OPEN,e!==i.readyState&&i.emit("readyStateChange","open"),i.latency=+new Date-r,i.emit("open"),n&&i.emit("reconnected"),i.clearTimeout("ping","pong").heartbeat(),i.buffer.length){var o=i.buffer.slice(),s=o.length,a=0;for(i.buffer.length=0;s>a;a++)i._write(o[a])}}),i.on("incoming::pong",function(t){i.online=!0,i.clearTimeout("pong").heartbeat(),i.latency=+new Date-t}),i.on("incoming::error",function(t){var e=i.timers.connect,n=t;if(i.attempt)return i.reconnect();if("string"==typeof t)n=new Error(t);else if(!(t instanceof Error)&&"object"==typeof t){n=new Error(t.message||t.reason);for(var o in t)t.hasOwnProperty(o)&&(n[o]=t[o])}i.listeners("error").length&&i.emit("error",n),e&&(~i.options.strategy.indexOf("timeout")?i.reconnect():i.end())}),i.on("incoming::data",function(t){i.decoder(t,function(e,n){return e?i.listeners("error").length&&i.emit("error",e):void(i.protocol(n)||i.transforms(i,i,"incoming",n,t))})}),i.on("incoming::end",function(){var e=i.readyState;if(i.disconnect)return i.disconnect=!1,i.end();if(i.readyState=t.CLOSED,e!==i.readyState&&i.emit("readyStateChange","end"),i.timers.connect&&i.end(),e!==t.OPEN)return i.attempt?i.reconnect():!1;this.writable=!1,this.readable=!1;for(var n in this.timers)this.clearTimeout(n);return i.emit("close"),~i.options.strategy.indexOf("disconnect")?i.reconnect():(i.emit("outgoing::end"),void i.emit("end"))}),i.client();for(var s in i.ark)i.ark[s].call(i,i,e);return i.NETWORK_EVENTS?(window.addEventListener?(window.addEventListener("offline",n,!1),window.addEventListener("online",o,!1)):document.body.attachEvent&&(document.body.attachEvent("onoffline",n),document.body.attachEvent("ononline",o)),i):i},t.prototype.protocol=function(t){if("string"!=typeof t||0!==t.indexOf("primus::"))return!1;var e=t.indexOf(":",8),n=t.slice(e+2);switch(t.slice(8,e)){case"pong":this.emit("incoming::pong",n);break;case"server":"close"===n&&(this.disconnect=!0);break;case"id":this.emit("incoming::id",n);break;default:return!1}return!0},t.prototype.transforms=function(t,e,n,o,r){var i={data:o},s=t.transformers[n];return function a(t,n){var o=s[t++];if(!o)return n();if(1===o.length){if(!1===o.call(e,i))return;return a(t,n)}o.call(e,i,function(o,r){return o?e.emit("error",o):void(!1!==r&&a(t,n))})}(0,function(){return"incoming"===n?e.emit("data",i.data,r):void e._write(i.data)}),this},t.prototype.id=function(t){return this.socket&&this.socket.id?t(this.socket.id):(this._write("primus::id::"),this.once("incoming::id",t))},t.prototype.open=function(){return o(this,"open"),!this.attempt&&this.options.timeout&&this.timeout(),this.emit("outgoing::open"),this},t.prototype.write=function(t){return o(this,"write"),this.transforms(this,this,"outgoing",t),!0},t.prototype._write=function(e){var n=this;return t.OPEN!==n.readyState?(this.buffer.length===this.options.queueSize&&this.buffer.splice(0,1),this.buffer.push(e),!1):(n.encoder(e,function(t,e){return t?n.listeners("error").length&&n.emit("error",t):void n.emit("outgoing::data",e)}),!0)},t.prototype.heartbeat=function(){function t(){n.clearTimeout("pong"),n.online&&(n.online=!1,n.emit("offline"),n.emit("incoming::end"))}function e(){var e=+new Date;n.clearTimeout("ping")._write("primus::ping::"+e),n.emit("outgoing::ping",e),n.timers.pong=setTimeout(t,n.options.pong)}var n=this;return n.options.ping?(n.timers.ping=setTimeout(e,n.options.ping),this):n},t.prototype.timeout=function(){function e(){n.removeListener("error",e).removeListener("open",e).removeListener("end",e).clearTimeout("connect")}var n=this;return n.timers.connect=setTimeout(function(){e(),n.readyState===t.OPEN||n.attempt||(n.emit("timeout"),~n.options.strategy.indexOf("timeout")?n.reconnect():n.end())},n.options.timeout),n.on("error",e).on("open",e).on("end",e)},t.prototype.clearTimeout=function(){for(var t=arguments,e=0,n=t.length;n>e;e++)this.timers[t[e]]&&clearTimeout(this.timers[t[e]]),delete this.timers[t[e]];return this},t.prototype.backoff=function(t,e){e=e||{};var n=this;return e.backoff?n:(e.maxDelay="maxDelay"in e?e.maxDelay:1/0,e.minDelay="minDelay"in e?e.minDelay:500,e.retries="retries"in e?e.retries:10,e.attempt=(+e.attempt||0)+1,e.factor="factor"in e?e.factor:2,e.attempt>e.retries?(t(new Error("Unable to retry"),e),n):(e.backoff=!0,e.timeout=1!==e.attempt?Math.min(Math.round((Math.random()+1)*e.minDelay*Math.pow(e.factor,e.attempt)),e.maxDelay):e.minDelay,n.timers.reconnect=setTimeout(function(){e.backoff=!1,n.clearTimeout("reconnect"),t(void 0,e)},e.timeout),n.emit("reconnecting",e),n))},t.prototype.reconnect=function(){var t=this;return t.attempt=t.attempt||t.clone(t.options.reconnect),t.backoff(function(e,n){return e?(t.attempt=null,t.emit("end")):(t.emit("reconnect",n),void t.emit("outgoing::reconnect"))},t.attempt),t},t.prototype.end=function(e){if(o(this,"end"),this.readyState===t.CLOSED&&!this.timers.connect)return this.timers.reconnect&&(this.clearTimeout("reconnect"),this.attempt=null,this.emit("end")),this;void 0!==e&&this.write(e),this.writable=!1,this.readable=!1;var n=this.readyState;this.readyState=t.CLOSED,n!==this.readyState&&this.emit("readyStateChange","end");for(var r in this.timers)this.clearTimeout(r);return this.emit("outgoing::end"),this.emit("close"),this.emit("end"),this},t.prototype.clone=function(t){return this.merge({},t)},t.prototype.merge=function(t){for(var e,n,o=Array.prototype.slice.call(arguments,1),r=0,i=o.length;i>r;r++){n=o[r];for(e in n)n.hasOwnProperty(e)&&(t[e]=n[e])}return t},t.prototype.parse=a,t.prototype.querystring=function(t){for(var e,n=/([^=?&]+)=([^&]*)/g,o={};e=n.exec(t);o[decodeURIComponent(e[1])]=decodeURIComponent(e[2]));return o},t.prototype.querystringify=function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e.join("&")},t.prototype.uri=function(t){var e=this.url,n=[],o=!1;t.query&&(o=!0),t=t||{},t.protocol="protocol"in t?t.protocol:"http",t.query=e.search&&"query"in t?"?"===e.search.charAt(0)?e.search.slice(1):e.search:!1,t.secure="secure"in t?t.secure:"https:"===e.protocol||"wss:"===e.protocol,t.auth="auth"in t?t.auth:e.auth,t.pathname="pathname"in t?t.pathname:this.pathname.slice(1),t.port="port"in t?+t.port:+e.port||(t.secure?443:80),t.host="host"in t?t.host:e.hostname||e.host.replace(":"+e.port,""),this.emit("outgoing::url",t);var r=443!==t.port&&80!==t.port?t.host+":"+t.port:t.host,i=this.querystring(t.query||"");return i._primuscb=+new Date+"-"+this.stamps++,t.query=this.querystringify(i),n.push(t.secure?t.protocol+"s:":t.protocol+":",""),n.push(t.auth?t.auth+"@"+r:r),t.pathname&&n.push(t.pathname),o?n.push("?"+t.query):delete t.query,t.object?t:n.join("/")},t.prototype.emits=function(t,e){var n=this;return function(o){var r=e?e.apply(n,arguments):o;setTimeout(function(){n.emit("incoming::"+t,r)},0)}},t.prototype.transform=function(t,e){return o(this,"transform"),t in this.transformers?(this.transformers[t].push(e),this):this.critical(new Error("Invalid transformer type"))},t.prototype.critical=function(t){if(this.listeners("error").length)return this.emit("error",t),this;throw t},t.connect=function(e,n){return new t(e,n)},t.EventEmitter=n,t.prototype.client=function(){var e,n=this,o=function(){if("undefined"!=typeof WebSocket)return WebSocket;if("undefined"!=typeof MozWebSocket)return MozWebSocket;try{return t.require("ws")}catch(e){}return void 0}();return o?(n.on("outgoing::open",function(){n.emit("outgoing::end");try{var t="ws+unix:"===n.url.protocol?"ws+unix":"ws",r="ws"===t;n.socket=e=3===o.length?new o(n.uri({protocol:t,query:r}),[],n.transport):new o(n.uri({protocol:t,query:r}))}catch(i){return n.emit("error",i)}e.binaryType="arraybuffer",e.onopen=n.emits("open"),e.onerror=n.emits("error"),e.onclose=n.emits("end"),e.onmessage=n.emits("data",function(t){return t.data})}),n.on("outgoing::data",function(t){if(e&&e.readyState===o.OPEN)try{e.send(t)}catch(r){n.emit("incoming::error",r)}}),n.on("outgoing::reconnect",function(){n.emit("outgoing::open")}),void n.on("outgoing::end",function(){e&&(e.onerror=e.onopen=e.onclose=e.onmessage=function(){},e.close(),e=null)})):n.critical(new Error("Missing required `ws` module. Please run `npm install --save ws`"))},t.prototype.authorization=!1,t.prototype.pathname="/primus",t.prototype.encoder=function(t,e){var n;try{t=JSON.stringify(t)}catch(o){n=o}e(n,t)},t.prototype.decoder=function(t,e){var n;if("string"!=typeof t)return e(n,t);try{t=JSON.parse(t)}catch(o){n=o}e(n,t)},t.prototype.version="2.4.12","object"==typeof JSON&&"function"==typeof JSON.stringify&&'["\u2028\u2029"]'===JSON.stringify(["\u2028\u2029"])&&(JSON.stringify=function(t){var e=/\u2028/g,n=/\u2029/g;return function(o,r,i){var s=t.call(this,o,r,i);return s&&(~s.indexOf("\u2028")&&(s=s.replace(e,"\\u2028")),~s.indexOf("\u2029")&&(s=s.replace(n,"\\u2029"))),s}}(JSON.stringify)),"undefined"!=typeof document&&"undefined"!=typeof navigator){document.addEventListener&&document.addEventListener("keydown",function(t){27===t.keyCode&&t.preventDefault&&t.preventDefault()},!1);var c=(navigator.userAgent||"").toLowerCase(),u=c.match(/.+(?:rv|it|ra|ie)[\/: ](\d+)\.(\d+)(?:\.(\d+))?/)||[],p=+[u[1],u[2]].join(".");!~c.indexOf("chrome")&&~c.indexOf("safari")&&534.54>p&&(t.prototype.AVOID_WEBSOCKETS=!0)}return t}),function(t){var e=function(t,e){var n=this;n.callbacks={},n.id=null,n.events={},n.rooms=[],n.state="disconnected",n.options=n.defaults();for(var o in t)n.options[o]=t[o];e&&(n.client=e)};e.prototype="undefined"==typeof Primus?new EventEmitter:new Primus.EventEmitter,e.prototype.defaults=function(){return{apiPath:"/api",url:window.location.origin}},e.prototype.connect=function(t){var e=this;e.client?(e.client.end(),e.client.open()):e.client=Primus.connect(e.options.url,e.options),e.client.on("open",function(){e.messageCount=0,e.configure(function(n){e.emit("connected"),"connected"===e.state||(e.state="connected","function"==typeof t&&t(null,n))})}),e.client.on("error",function(t){e.emit("error",t)}),e.client.on("reconnect",function(){e.emit("reconnect")}),e.client.on("reconnecting",function(){e.emit("reconnecting"),e.state="reconnecting",e.emit("disconnected")}),e.client.on("end",function(){"disconnected"!==e.state&&(e.state="disconnected",e.emit("disconnected"))}),e.client.on("data",function(t){e.handleMessage(t)})},e.prototype.configure=function(t){var e=this;e.rooms.forEach(function(t){e.send({event:"roomAdd",room:t})}),e.detailsView(function(n){e.id=n.data.id,e.fingerprint=n.data.fingerprint,e.rooms=n.data.rooms,t(n)})},e.prototype.send=function(t,e){var n=this;n.messageCount++,"function"==typeof e&&(n.callbacks[n.messageCount]=e),n.client.write(t)},e.prototype.handleMessage=function(t){var e=this;e.emit("message",t),"response"===t.context?("function"==typeof e.callbacks[t.messageCount]&&e.callbacks[t.messageCount](t),delete e.callbacks[t.messageCount]):"user"===t.context?e.emit("say",t):"alert"===t.context?e.emit("alert",t):t.welcome&&"api"===t.context?(e.welcomeMessage=t.welcome,e.emit("welcome",t)):"api"===t.context&&e.emit("api",t)},e.prototype.action=function(t,e,n){n||"function"!=typeof e||(n=e,e=null),e||(e={}),e.action=t,"connected"!==this.state?this.actionWeb(e,n):this.actionWebSocket(e,n)},e.prototype.actionWeb=function(t,e){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status){var t=JSON.parse(n.responseText);e(null,t)}else e(n.statusText,n.responseText)};var o="?";for(var r in t)o+=r+"="+t[r]+"&";var i="GET";t.httpMethod&&(i=t.httpMethod);var s=this.options.url+this.options.apiPath+o;n.open(i,s,!0),n.send()},e.prototype.actionWebSocket=function(t,e){this.send({event:"action",params:t},e)},e.prototype.say=function(t,e,n){this.send({event:"say",room:t,message:e},n)},e.prototype.file=function(t,e){this.send({event:"file",file:t},e)},e.prototype.detailsView=function(t){this.send({event:"detailsView"},t)},e.prototype.roomView=function(t,e){this.send({event:"roomView",room:t},e)},e.prototype.roomAdd=function(t,e){var n=this;n.send({event:"roomAdd",room:t},function(t){n.configure(function(){"function"==typeof e&&e(t)})})},e.prototype.roomLeave=function(t,e){var n=this,o=n.rooms.indexOf(t);o>-1&&n.rooms.splice(o,1),this.send({event:"roomLeave",room:t},function(t){n.configure(function(){"function"==typeof e&&e(t)})})},e.prototype.documentation=function(t){this.send({event:"documentation"},t)},e.prototype.disconnect=function(){this.state="disconnected",this.client.end(),this.emit("disconnected")};var n=e;t.ActionheroClient=e,t.actionheroClient=n}("undefined"==typeof exports?window:exports);